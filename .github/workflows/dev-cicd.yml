name: Deploy To EC2 (dev-version)

on:
  push:
    branches:
      - main

jobs:
  # 1ï¸âƒ£ ë³€ê²½ ì‚¬í•­ ê°ì§€ Job
  # ì´ Jobì€ í•­ìƒ ì‹¤í–‰ë˜ì–´ ì–´ë–¤ íŒŒì¼ ê·¸ë£¹ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
  filter:
    runs-on: ubuntu-latest
    outputs:
      app: ${{ steps.filter.outputs.app }}
      es: ${{ steps.filter.outputs.es }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          # base: 'main' # ê¸°ë³¸ ë¸Œëœì¹˜ì™€ ë¹„êµ
          filters: |
            # â¬‡ï¸ 'app' ê·¸ë£¹: ì´ íŒŒì¼ë“¤ì´ ë³€ê²½ë˜ë©´ app=trueê°€ ë©ë‹ˆë‹¤.
            app:
              - 'src/**'
              - 'build.gradle'
              - 'gradlew'
              - 'Dockerfile-dev'
            
            # â¬‡ï¸ 'es' ê·¸ë£¹: ì´ íŒŒì¼ì´ ë³€ê²½ë˜ë©´ es=trueê°€ ë©ë‹ˆë‹¤.
            es:
              - 'Dockerfile-elasticsearch'

  # 2ï¸âƒ£ ES ì´ë¯¸ì§€ ë¹Œë“œ Job
  # 'filter' Jobì˜ ê²°ê³¼, 'es' ê·¸ë£¹ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
  build-es-image:
    runs-on: ubuntu-latest
    needs: filter # 'filter' Jobì´ ì™„ë£Œëœ í›„ì— ì‹¤í–‰
    if: needs.filter.outputs.es == 'true' # 'es' ê·¸ë£¹ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ!
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push ES Image
        run: |
          echo "âœ… Dockerfile-elasticsearch ë³€ê²½ ê°ì§€: ìƒˆ ES ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•˜ê³  ECRì— í‘¸ì‹œí•©ë‹ˆë‹¤."
          docker build -t third-tool-elasticsearch -f ./Dockerfile-elasticsearch .
          docker tag third-tool-elasticsearch:latest ${{ steps.login-ecr.outputs.registry }}/third-tool-server:elasticsearch
          docker push ${{ steps.login-ecr.outputs.registry }}/third-tool-server:elasticsearch

  # 3ï¸âƒ£ Spring Boot ì•± ë¹Œë“œ ë° ë°°í¬ Job
  # 'filter' Jobì˜ ê²°ê³¼, 'app' ê·¸ë£¹ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
  deploy-app:
    runs-on: ubuntu-latest
    needs: filter # 'filter' Jobì´ ì™„ë£Œëœ í›„ì— ì‹¤í–‰
    if: needs.filter.outputs.app == 'true' # 'app' ê·¸ë£¹ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ!
    steps:
      # 1ï¸âƒ£ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ JDK 21 ì„¤ì¹˜
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Check working directory
        run: pwd && ls -R

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 4ï¸âƒ£ Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # 5ï¸âƒ£ AWS ì ‘ê·¼ ê¶Œí•œ ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # 6ï¸âƒ£ ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 7ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ (ìš°ë¦¬ Dockerfile ê¸°ë°˜)
      - name: Build Docker image
        run: docker build -t third-tool-server -f ./Dockerfile-dev .

      # 8ï¸âƒ£ ì´ë¯¸ì§€ íƒœê·¸ ì§€ì •
      - name: Tag Docker image
        run: docker tag third-tool-server:latest ${{ steps.login-ecr.outputs.registry }}/third-tool-server:latest

      # 9ï¸âƒ£ ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
      - name: Push to Amazon ECR
        run: docker push ${{ steps.login-ecr.outputs.registry }}/third-tool-server:latest

      # ğŸ”Ÿ EC2 ë°°í¬ (SSH)
      # (ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ì™€ ë™ì¼)
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            echo "ğŸš€ [Deploy] Starting deployment on EC2..."

            cd /home/ubuntu/third-tool || mkdir -p /home/ubuntu/third-tool
            cd /home/ubuntu/third-tool
            
            
            docker compose down || true
            docker compose up -d
            
             # 2ï¸âƒ£ DB ì»¨í…Œì´ë„ˆê°€ ì™„ì „íˆ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            echo "â³ Waiting for MySQL to be ready..."
            for i in {1..5}; do
              if docker exec local-mysql-db mysqladmin ping -h"localhost" --silent; then
                echo "âœ… MySQL is ready!"
                break
              fi
              echo "â±ï¸ MySQL not ready yet... ($i/15)"
              sleep 5
            done

            # 1ï¸âƒ£ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            echo "ğŸ§¹ Stopping and removing old Spring container..."
            docker stop third-tool-server || true
            docker rm third-tool-server || true
            
            
            # 2ï¸âƒ£ ìµœì‹  ECR ì´ë¯¸ì§€ pull
            echo "ğŸ“¦ Pulling latest Spring image from ECR..."
            docker pull ${{ steps.login-ecr.outputs.registry }}/third-tool-server:latest


            # 5ï¸âƒ£ Spring ì„œë²„ ì‹¤í–‰ (Compose ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°)
            echo "âš™ï¸ Running Spring Boot container..."
            docker run -d \
            --name third-tool-server \
            --network third-tool_default \
            -p 8080:8080 \
            -v /home/ubuntu/third-tool/application.yml:/app/config/application.yml \
            -e SPRING_PROFILES_ACTIVE=dev \
            -e DB_NAME=${{ secrets.DB_NAME }} \
            -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
            -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            -e KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}" \
            -e KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}" \
            -e NAVER_CLIENT_ID="${{ secrets.NAVER_CLIENT_ID }}" \
            -e NAVER_CLIENT_SECRET="${{ secrets.NAVER_CLIENT_SECRET }}" \
            -e TZ=Asia/Seoul \
            ${{ steps.login-ecr.outputs.registry }}/third-tool-server:latest

            # 6ï¸âƒ£ ìƒíƒœ í™•ì¸
            echo "ğŸ” Checking running containers..."
            docker ps

            echo "âœ… Deployment completed successfully!"