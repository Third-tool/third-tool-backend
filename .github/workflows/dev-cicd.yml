name: Deploy To EC2(dev ë²„ì „)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ JDK 21 ì„¤ì¹˜
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Check working directory
        run: pwd && ls -R

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 4ï¸âƒ£ Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ í¬í•¨)
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # 5ï¸âƒ£ AWS ì ‘ê·¼ ê¶Œí•œ ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-2
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # 6ï¸âƒ£ ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2



      # 7ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ (ìš°ë¦¬ Dockerfile ê¸°ë°˜)
      - name: Build Docker image
        run: docker build -t third-tool-server -f ./Dockerfile-dev .

      # 8ï¸âƒ£ ì´ë¯¸ì§€ íƒœê·¸ ì§€ì •
      - name: Tag Docker image
        run: docker tag third-tool-server:latest ${{ steps.login-ecr.outputs.registry }}/third-tool-server:latest

      # 9ï¸âƒ£ ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ
      - name: Push to Amazon ECR
        run: docker push ${{ steps.login-ecr.outputs.registry }}/third-tool-server:latest

      # ===================================================
      # ğŸ§© Elasticsearch Docker ì´ë¯¸ì§€ (Nori) â€” ë³€ê²½ ì‹œì—ë§Œ ìƒˆë¡œ ë¹Œë“œ
      # ===================================================

      - name: Check if Elasticsearch Dockerfile changed
        id: es-change
        run: |
          echo "ğŸ” Checking changes for Dockerfile-elasticsearch..."
          
          # github.event.before ~ github.sha ì‚¬ì´ ë³€ê²½ íŒŒì¼ í™•ì¸
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || true)
          echo "Changed files between commits:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q "Dockerfile-elasticsearch"; then
            echo "âœ… Dockerfile-elasticsearch ë³€ê²½ ê°ì§€: ìƒˆ ES ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤."
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ Dockerfile-elasticsearch ë³€ê²½ ì—†ìŒ: ê¸°ì¡´ ì´ë¯¸ì§€ ì¬ì‚¬ìš© ë¡œì§ ì‚¬ìš©."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # 9-2ï¸âƒ£ ES ì´ë¯¸ì§€ ë¹Œë“œ/ì¬ì‚¬ìš© ë¡œì§
      - name: Build or Reuse Elasticsearch Docker image (Nori)
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ES_CHANGED: ${{ steps.es-change.outputs.changed }}
        run: |
          echo "ES_CHANGED flag = $ES_CHANGED"

          build_and_push() {
            echo "âš™ï¸ Building new Elasticsearch (Nori) image..."
            docker build -t third-tool-elasticsearch -f ./Dockerfile-elasticsearch .
            docker tag third-tool-elasticsearch:latest "$ECR_REGISTRY/third-tool-elasticsearch:latest"
            echo "ğŸš€ Pushing new Elasticsearch image to ECR..."
            docker push "$ECR_REGISTRY/third-tool-elasticsearch:latest"
          }

          if [ "$ES_CHANGED" = "true" ]; then
            # ğŸ”¥ Dockerfile-elasticsearchê°€ ë³€ê²½ëœ ê²½ìš°: ë¬´ì¡°ê±´ ìƒˆ ë¹Œë“œ + í‘¸ì‹œ
            echo "ğŸ”„ Dockerfile-elasticsearch ë³€ê²½ë¨ â†’ ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ"
            build_and_push
          else
            # ë³€ê²½ ì—†ì„ ë•Œ: ECRì— ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©, ì—†ìœ¼ë©´ ìµœì´ˆ 1íšŒ ë¹Œë“œ
            echo "ğŸ” Dockerfile-elasticsearch ë³€ê²½ ì—†ìŒ â†’ ê¸°ì¡´ ì´ë¯¸ì§€ ì¡´ì¬ ì—¬ë¶€ í™•ì¸"
            if docker pull "$ECR_REGISTRY/third-tool-elasticsearch:latest"; then
              echo "âœ… Existing Elasticsearch image found in ECR. Reusing it."
            else
              echo "âš ï¸ No existing Elasticsearch image found in ECR. Building a new one..."
              build_and_push
            fi
          fi

      # ğŸ”Ÿ EC2 ë°°í¬ (SSH)
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            echo "ğŸš€ [Deploy] Starting deployment on EC2..."

            cd /home/ubuntu/third-tool || mkdir -p /home/ubuntu/third-tool
            cd /home/ubuntu/third-tool
            
  
            docker compose down || true
            docker compose up -d
            
             # 2ï¸âƒ£ DB ì»¨í…Œì´ë„ˆê°€ ì™„ì „íˆ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            echo "â³ Waiting for MySQL to be ready..."
            for i in {1..5}; do
              if docker exec local-mysql-db mysqladmin ping -h"localhost" --silent; then
                echo "âœ… MySQL is ready!"
                break
              fi
              echo "â±ï¸ MySQL not ready yet... ($i/15)"
              sleep 5
            done

            # 1ï¸âƒ£ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            echo "ğŸ§¹ Stopping and removing old Spring container..."
            docker stop third-tool-server || true
            docker rm third-tool-server || true
     

            # 2ï¸âƒ£ ìµœì‹  ECR ì´ë¯¸ì§€ pull
            echo "ğŸ“¦ Pulling latest Spring image from ECR..."
            docker pull ${{ steps.login-ecr.outputs.registry }}/third-tool-server:latest


            # 5ï¸âƒ£ Spring ì„œë²„ ì‹¤í–‰ (Compose ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°)
            echo "âš™ï¸ Running Spring Boot container..."
            docker run -d \
            --name third-tool-server \
            --network third-tool_default \
            -p 8080:8080 \
            -v /home/ubuntu/third-tool/application.yml:/app/config/application.yml \
            -e SPRING_PROFILES_ACTIVE=dev \
            -e DB_NAME=${{ secrets.DB_NAME }} \
            -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
            -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            -e KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}" \
            -e KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}" \
            -e NAVER_CLIENT_ID="${{ secrets.NAVER_CLIENT_ID }}" \
            -e NAVER_CLIENT_SECRET="${{ secrets.NAVER_CLIENT_SECRET }}" \
            -e TZ=Asia/Seoul \
            ${{ steps.login-ecr.outputs.registry }}/third-tool-server:latest

            # 6ï¸âƒ£ ìƒíƒœ í™•ì¸
            echo "ğŸ” Checking running containers..."
            docker ps

            echo "âœ… Deployment completed successfully!"
